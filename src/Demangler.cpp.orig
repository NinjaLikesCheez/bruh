//
//  Demangler.cpp
//  bruh
//
//  Created by NinjaLikesCheez on 23/11/2021.
//

#include "Demangler.h"

#include <swift/Demangling/Demangle.h>
#include <llvm/Demangle/Demangle.h>
#include <llvm/Support/raw_ostream.h>

#include <iostream>

string Demangler::demangle(const string symbol) {
    // If we've seen this symbol before, return the result of the previous demangling
    if (symbols.contains(symbol)) {
        return symbols[symbol];
    }

    // TODO: handle hidden names, BCSymbol lookup, OBJC class refs, ivar refs, accelerate dispatch naming, etc
    auto strippedSymbol = symbol.find('\1') == 0 ? symbol.substr(1) : symbol;

<<<<<<< Updated upstream
    // Some patterns I've seen that require partial demangling:
||||||| constructed merge base
    llvm::outs() << "strippedSymbol: " << strippedSymbol << "\n";

    // Some patterns I've seen that require partial demangling:
=======
    // Swift
    // Sometimes you see partial patterns in Swift (only when manually compiled?):
>>>>>>> Stashed changes
    // got.$sym
    auto dotPosition = strippedSymbol.find_first_of(".");
    std::string remaining = "";

    if (dotPosition != std::string::npos) {
        // got.$sym
        if (strippedSymbol.front() != '$' && strippedSymbol.at(dotPosition + 1) == '$') {
            remaining = strippedSymbol.substr(0, dotPosition);
            strippedSymbol = strippedSymbol.substr(dotPosition + 1, strippedSymbol.size());
        }
    }

    if (swift::Demangle::isSwiftSymbol(strippedSymbol)) {
        auto demangledSymbol = swift::Demangle::demangleSymbolAsString(strippedSymbol);

        if (!remaining.empty()) {
            auto newSymbol = remaining + "." + demangledSymbol;
            symbols[symbol] = newSymbol;

            return newSymbol;
        }

        symbols[symbol] = demangledSymbol;

        return demangledSymbol;
    }

<<<<<<< Updated upstream
    symbols[symbol] = symbol;

||||||| constructed merge base
=======
    // C++, Rust, msft, dlang, whatever else LLVM supports
    std::string demangledName = llvm::demangle(strippedSymbol);

    if (strippedSymbol != demangledName) {
        symbols[symbol] = demangledName;
        return;
    }

    // ????
    symbols[symbol] = symbol;

>>>>>>> Stashed changes
    return symbol;
}

string Demangler::demangle(const StringRef symbol) {
    return demangle(symbol.str());
}
